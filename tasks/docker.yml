---
- name: Install Jellyfin
  become: true
  tags: install
  block:

    - name: Add 'jellyfin' group
      ansible.builtin.group:
        name: jellyfin
        state: present
        gid: "{{ gid }}"

    - name: Add Ansible user to jellyfin
      ansible.builtin.user:
        name: "{{ user }}"
        groups: jellyfin
        append: true

    - name: Add 'jellyfin' user
      ansible.builtin.user:
        name: jellyfin
        group: jellyfin
        uid: "{{ uid }}"

    - name: Create Jellyfin config directory
      ansible.builtin.file:
        path: /home/jellyfin/config
        state: directory
        mode: 0775
        owner: jellyfin
        group: jellyfin

    - name: Create Jellyfin cache directory
      ansible.builtin.file:
        path: /home/jellyfin/cache
        state: directory
        mode: 0775
        owner: jellyfin
        group: jellyfin

    - name: Create jellyfin_media volume
      docker_volume:
        driver: "local"
        driver_options:
          type: nfs
          o: "addr=nas.home,nolock,soft,rw"
          device: :/volume1/media/data/media
        volume_name: jellyfin_media

    - name: Instantiate passwd database
      getent:
        database: passwd

    - name: Create Jellyfin container
      community.docker.docker_container:
        name: jellyfin
        image: jellyfin/jellyfin:latest
        pull: true
        user: "{{ getent_passwd['jellyfin'].1 }}:{{ getent_passwd['jellyfin'].2 }}"
        restart_policy: unless-stopped
        volumes:
          - /home/jellyfin/config:/config
          - /home/jellyfin/cache:/cache
          - jellyfin_media:/media
        ports:
          - "{{ http_port }}:{{ http_port }}"
          - "{{ https_port }}:{{ https_port }}"
          - "{{ service_discovery_port }}:{{ service_discovery_port }}"
          - "{{ auto_discovery_port }}:{{ auto_discovery_port }}"
        env:
          JELLYFIN_PublishedServerUrl: "{{ inventory_hostname }}"

#    - name: Copy nginx config file
#      template:
#        src: nginx.conf.j2
#        dest: /etc/nginx/nginx.conf
#        owner: root
#        group: root
#        mode: u=rw,g=r,o=r
#      notify:
#        - restart nginx
